version: '3'

vars:
  SERVER_PORT: 8080
  BASE_URL: http://localhost:{{.SERVER_PORT}}

tasks:
  # å¼€å‘ç›¸å…³ä»»åŠ¡
  dev:
    desc: å¯åŠ¨å¼€å‘æœåŠ¡å™¨
    cmds:
      - echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
      - go run cmd/server/main.go
    
  build:
    desc: æ„å»ºé¡¹ç›®
    cmds:
      - echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
      - go build -o bin/fastgox-api-starter cmd/server/main.go
      - echo "âœ… æ„å»ºå®Œæˆ: bin/fastgox-api-starter"

  clean:
    desc: æ¸…ç†æ„å»ºæ–‡ä»¶
    cmds:
      - echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
      - rm -rf bin/
      - rm -f coverage.out coverage.html
      - go clean
      - echo "âœ… æ¸…ç†å®Œæˆ"

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
      - go fmt ./...
      - echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

  tidy:
    desc: æ•´ç†ä¾èµ–
    cmds:
      - echo "ğŸ“¦ æ•´ç†ä¾èµ–..."
      - go mod tidy
      - echo "âœ… ä¾èµ–æ•´ç†å®Œæˆ"

  # Swaggerç›¸å…³ä»»åŠ¡
  swagger:
    desc: ç”ŸæˆSwaggeræ–‡æ¡£
    cmds:
      - echo "ğŸ“š ç”ŸæˆSwaggeræ–‡æ¡£..."
      - swag init -g cmd/server/main.go -o docs
      - echo "âœ… Swaggeræ–‡æ¡£ç”Ÿæˆå®Œæˆ"

  swagger-serve:
    desc: å¯åŠ¨æœåŠ¡å™¨å¹¶æ‰“å¼€Swaggeræ–‡æ¡£
    deps: [swagger]
    cmds:
      - echo "ğŸŒ å¯åŠ¨æœåŠ¡å™¨å¹¶æ‰“å¼€Swaggeræ–‡æ¡£..."
      - echo "Swaggeræ–‡æ¡£åœ°å€: {{.BASE_URL}}/swagger/index.html"
      - task: dev

  # æµ‹è¯•ç›¸å…³ä»»åŠ¡
  test:
    desc: è¿è¡ŒGoæµ‹è¯•å¥—ä»¶
    dir: test
    cmds:
      - echo "ğŸ§ª è¿è¡ŒGoæµ‹è¯•å¥—ä»¶..."
      - echo "è¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ {{.BASE_URL}}"
      - go test -v

  test-api:
    desc: è¿è¡ŒAPIæ¥å£æµ‹è¯•
    dir: test
    cmds:
      - echo "ğŸš€ è¿è¡ŒAPIæ¥å£æµ‹è¯•..."
      - echo "è¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ {{.BASE_URL}}"
      - go run run_tests.go

  test-server:
    desc: å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œæµ‹è¯•
    cmds:
      - echo "ğŸ”„ å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œæµ‹è¯•..."
      - task: start-server-bg
      - sleep 3
      - task: test-api
      - task: stop-server

  start-server-bg:
    desc: åå°å¯åŠ¨æœåŠ¡å™¨
    platforms: [linux, darwin]
    cmds:
      - echo "ğŸš€ åå°å¯åŠ¨æœåŠ¡å™¨..."
      - nohup go run cmd/server/main.go > server.log 2>&1 &
      - echo $! > server.pid
      - echo "æœåŠ¡å™¨å·²åœ¨åå°å¯åŠ¨ï¼ŒPIDä¿å­˜åœ¨ server.pid"

  start-server-bg:windows:
    desc: åå°å¯åŠ¨æœåŠ¡å™¨ (Windows)
    platforms: [windows]
    cmds:
      - echo "ğŸš€ åå°å¯åŠ¨æœåŠ¡å™¨..."
      - start /B go run cmd/server/main.go > server.log 2>&1
      - echo "æœåŠ¡å™¨å·²åœ¨åå°å¯åŠ¨"

  stop-server:
    desc: åœæ­¢åå°æœåŠ¡å™¨
    platforms: [linux, darwin]
    cmds:
      - echo "ğŸ›‘ åœæ­¢åå°æœåŠ¡å™¨..."
      - |
        if [ -f server.pid ]; then
          kill $(cat server.pid) 2>/dev/null || true
          rm -f server.pid server.log
          echo "âœ… æœåŠ¡å™¨å·²åœæ­¢"
        else
          echo "âš ï¸  æœªæ‰¾åˆ°æœåŠ¡å™¨PIDæ–‡ä»¶"
        fi

  stop-server:windows:
    desc: åœæ­¢åå°æœåŠ¡å™¨ (Windows)
    platforms: [windows]
    cmds:
      - echo "ğŸ›‘ åœæ­¢åå°æœåŠ¡å™¨..."
      - taskkill /F /IM go.exe 2>nul || echo "æœªæ‰¾åˆ°è¿è¡Œçš„Goè¿›ç¨‹"
      - del server.log 2>nul || echo ""
      - echo "âœ… æœåŠ¡å™¨å·²åœæ­¢"

  check-server:
    desc: æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    cmds:
      - echo "ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€..."
      - |
        if curl -s {{.BASE_URL}}/swagger/index.html > /dev/null 2>&1; then
          echo "âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸: {{.BASE_URL}}"
        else
          echo "âŒ æœåŠ¡å™¨æœªå“åº”: {{.BASE_URL}}"
        fi

  # å®Œæ•´çš„å¼€å‘å·¥ä½œæµ
  setup:
    desc: åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ
    cmds:
      - echo "ğŸ”§ åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ..."
      - task: tidy
      - task: swagger
      - echo "âœ… é¡¹ç›®ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

  dev-full:
    desc: å®Œæ•´å¼€å‘æµç¨‹ï¼ˆæ ¼å¼åŒ–ã€ç”Ÿæˆæ–‡æ¡£ã€å¯åŠ¨æœåŠ¡å™¨ï¼‰
    cmds:
      - task: fmt
      - task: swagger
      - task: dev

  # éƒ¨ç½²ç›¸å…³ä»»åŠ¡
  release:
    desc: æ„å»ºå‘å¸ƒç‰ˆæœ¬
    cmds:
      - echo "ğŸš€ æ„å»ºå‘å¸ƒç‰ˆæœ¬..."
      - task: clean
      - task: fmt
      - task: tidy
      - task: swagger
      - task: build
      - echo "âœ… å‘å¸ƒç‰ˆæœ¬æ„å»ºå®Œæˆ"

  # å¸®åŠ©ä¿¡æ¯
  help:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - echo "ğŸ“‹ å¯ç”¨ä»»åŠ¡åˆ—è¡¨ï¼š"
      - echo ""
      - echo "å¼€å‘ä»»åŠ¡ï¼š"
      - echo "  dev          - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
      - echo "  dev-full     - å®Œæ•´å¼€å‘æµç¨‹ï¼ˆæ ¼å¼åŒ–ã€ç”Ÿæˆæ–‡æ¡£ã€å¯åŠ¨æœåŠ¡å™¨ï¼‰"
      - echo "  build        - æ„å»ºé¡¹ç›®"
      - echo "  clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
      - echo "  fmt          - æ ¼å¼åŒ–ä»£ç "
      - echo "  tidy         - æ•´ç†ä¾èµ–"
      - echo ""
      - echo "æ–‡æ¡£ä»»åŠ¡ï¼š"
      - echo "  swagger      - ç”ŸæˆSwaggeræ–‡æ¡£"
      - echo "  swagger-serve - å¯åŠ¨æœåŠ¡å™¨å¹¶æ‰“å¼€Swaggeræ–‡æ¡£"
      - echo ""
      - echo "æµ‹è¯•ä»»åŠ¡ï¼š"
      - echo "  test         - è¿è¡ŒGoæµ‹è¯•å¥—ä»¶"
      - echo "  test-api     - è¿è¡ŒAPIæ¥å£æµ‹è¯•"
      - echo "  test-server  - å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œæµ‹è¯•"
      - echo ""
      - echo "æœåŠ¡å™¨ç®¡ç†ï¼š"
      - echo "  start-server-bg - åå°å¯åŠ¨æœåŠ¡å™¨"
      - echo "  stop-server     - åœæ­¢åå°æœåŠ¡å™¨"
      - echo "  check-server    - æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€"
      - echo ""
      - echo "é¡¹ç›®ç®¡ç†ï¼š"
      - echo "  setup        - åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
      - echo "  release      - æ„å»ºå‘å¸ƒç‰ˆæœ¬"
      - echo ""
      - echo "ä½¿ç”¨æ–¹æ³•: task <ä»»åŠ¡å>"

  default:
    desc: é»˜è®¤ä»»åŠ¡ï¼ˆæ˜¾ç¤ºå¸®åŠ©ï¼‰
    cmds:
      - task: help
